<!DOCTYPE html>
<html>
  <head>
    <title>Hệ thống giáo dục việt nhật</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="format-detection" content="telephone=no" />
    <meta name="full-screen" content="yes" />
    <meta name="x5-full-screen" content="true" />
    <link rel="apple-touch-icon" href="asset/images/logo.png" />
    <link rel="shortcut icon" href="asset/images/logo.png" />
    <meta name="360-full-screen" content="true" />
    <meta name="mobile-web-app-capable" content="yes" />

    <link href="asset/css/animate-v411.css" rel="stylesheet" />
    <script src="asset/js/jquery-3.5.1.min.js"></script>
    <script src="asset/js/current-device.min.js"></script>
    <link href="asset/css/styleSearch.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Paytone+One&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Coiny&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lobster&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playball&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Agbalumo&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <script type="text/javascript">
      window.check_viewport = function () {
        const screenWidth =
          window.outerWidth > 0 ? window.outerWidth : window.screen.width;
        let content = "";

        if (screenWidth > 520) {
          // Viewport cho màn hình > 520px
          content =
            "width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no";
        } else {
          // Viewport cho màn hình ≤ 520px
          const scale = screenWidth / 520;
          content = `width=520, user-scalable=no, initial-scale=${scale}, minimum-scale=${scale}, maximum-scale=${scale}`;
        }

        // Tìm hoặc cập nhật thẻ <meta name="viewport">
        let docViewport = document.head.querySelector('meta[name="viewport"]');

        if (docViewport) {
          if (docViewport.getAttribute("content") !== content) {
            docViewport.setAttribute("content", content);
          }
        } else {
          docViewport = document.createElement("meta");
          docViewport.setAttribute("name", "viewport");
          docViewport.setAttribute("content", content);
          document.head.appendChild(docViewport);
        }
      };

      // Gọi ngay khi trang load
      window.check_viewport();

      // Lắng nghe sự kiện resize để cập nhật viewport
      window.addEventListener("resize", function () {
        clearTimeout(window.check_viewport_timer);
        window.check_viewport_timer = setTimeout(window.check_viewport, 200);
      });
    </script>
    <style>
      .page-view {
        background-image: url(asset/images/bg-camon-page.jpg);
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        min-height: 100vh;
        position: relative;
      }
    </style>
  </head>
  <body>
    <div class="page-view">
      <div class="logo">
        <img src="asset/images/logo-horizontal.png" alt="" />
      </div>
      <div id="content-1">
        <div class="form-insert">
          <div class="form-group-inline --row-1">
            <div class="label">Họ và tên thầy cô:</div>
            <input type="text" name="" id="teacherName" class="form-control" />
          </div>
          <div class="form-group-inline --row-2">
            <div class="form-group">
              <div class="label">Ngày:</div>
              <input type="text" name="" id="birthDay" class="form-control" />
            </div>
            <div class="form-group">
              <div class="label">Tháng:</div>
              <select name="" id="birthMonth" class="form-control">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
            </div>
            <div class="form-group">
              <div class="label">Năm sinh:</div>
              <input type="text" name="" id="birthYear" class="form-control" />
            </div>
          </div>
        </div>
        <div class="box-error">
          <div id="txt-error">Thầy/cô vui lòng kiểm tra lại thông tin</div>
        </div>
        <div class="envlope-wrapper">
          <div id="envelope" class="close">
            <div class="front flap"></div>
            <div class="front pocket"></div>
            <div class="heart-center"></div>
            <div class="letter">
              <div class="words line1"></div>
              <div class="words line2"></div>
              <div class="words line3"></div>
              <div class="words line4"></div>
            </div>
            <div class="hearts">
              <div class="heart a1"></div>
              <div class="heart a2"></div>
              <div class="heart a3"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="content-2" style="display: none">
        <!-- style="display: none;" -->
        <div class="txt-1">Thank You</div>
        <div class="txt-2">
          Cảm ơn
          <span
            ><span id="sex">cô/thầy</span>
            <span id="name">Nguyễn Văn A</span></span
          >
          vì đã luôn sát cánh cùng Việt Nhật trong suốt
        </div>
        <div class="txt-date">
          <span id="year">7</span>&nbsp;năm&nbsp;<span id="month">11</span>&nbsp;tháng
        </div>
        <div class="txt-3">
          Việt Nhật biết ơn những nỗ lực của bạn để góp phần tạo nên một hành
          trình đầy ý nghĩa, nơi tri thức và yêu thương luôn được trao đi.
        </div>
      </div>
      <div class="reset" style="display: none">
        <button id="open">Open</button>
        <button id="reset">Reset</button>
      </div>
      <div id="img-bottom">
        <img src="asset/images/bg-camon-bottom.png" alt="" />
      </div>
    </div>
    <audio
      id="myAudio"
      src="asset/mp3/sound-camon.mp3"
      hidden="hidden"
      preload="auto"      
    ></audio>
    <script>
      var envelope = $("#envelope");
      var btn_open = $("#open");
      var btn_reset = $("#reset");

      btn_reset.click(function () {
        close();
      });

      function close() {
        envelope.addClass("close").removeClass("open");
      }
      // Hàm open() và display() của bạn
      function open() {
        console.log("Hàm open() bắt đầu chạy.");
        const envelope = $("#envelope"); // Lấy đối tượng jQuery cho envelope
        envelope.addClass("open").removeClass("close"); // Thêm class "open", bỏ "close"

        // Chờ 3 giây (3000ms) sau đó mới gọi hàm display()
        setTimeout(function () {
          audioPlay = document.getElementById("myAudio");
          audioPlay.play();
          // Sử dụng hàm ẩn danh để đảm bảo display được gọi sau độ trễ
          display();
        }, 3000); // Đã chỉnh thời gian trễ thành 3000ms (3 giây)
        console.log("1");
      }

      function display() {
        console.log("Hàm display() bắt đầu chạy.");
        console.log("2");
        $("#content-1").fadeOut(function () {
          // Khi fadeOut() hoàn tất, callback function này sẽ chạy
          console.log("content-1 đã mờ dần hoàn tất.");
          // Sau khi content-1 fadeOut xong, chờ 1 giây rồi mới fadeIn content-2
          setTimeout(function () {
            // Sử dụng hàm ẩn danh để đảm bảo fadeIn được gọi sau độ trễ
            $("#content-2").fadeIn();
            $("#img-bottom").fadeIn();
            console.log("content-2 đã hiện dần hoàn tất.");
          }, 1000); // Chờ 1 giây (1000ms)
        });
      }

      $(document).ready(function () {
        let nameMatches = [];

        // Ẩn #txt-error khi trang được tải lần đầu
        $("#txt-error").hide();

        envelope.on("click", function () {
          const teacherName = $("#teacherName").val().trim();

          const birthDayValue = $("#birthDay").val().trim();
          const birthMonthValue = $("#birthMonth").val().trim();
          const birthYearValue = $("#birthYear").val().trim();

          // Reset các span hiển thị kết quả
          $("#name").text("");
          $("#sex").text("");
          $("#year").text("");
          $("#month").text("");

          // Reset danh sách khớp tên
          nameMatches = [];

          // Ẩn #txt-error và đặt lại nội dung mặc định của lỗi khi bắt đầu tìm kiếm mới
          $("#txt-error").hide();
          $("#txt-error").text("Thầy/cô vui lòng kiểm tra lại thông tin");

          // 1. Kiểm tra #teacherName rỗng/null
          if (!teacherName) {
            $("#txt-error").text("Vui lòng nhập Họ và tên thầy cô.").show();
            return; // Dừng hàm nếu tên trống
          }

          const cleanedTeacherNameInput = teacherName.toLowerCase();

          $.ajax({
            url: "asset/js/data.json", // Đảm bảo đường dẫn này đúng
            method: "GET",
            dataType: "json",
            success: function (data) {
              if (!Array.isArray(data)) {
                $("#txt-error").text("Lỗi: Dữ liệu JSON không hợp lệ.").show();
                return;
              }

              // Bước 1: Lọc theo tên từ data.json
              nameMatches = data.filter((item) => {
                const cleanedTeacherNameJson = item["fullname"]
                  ? item["fullname"].trim().toLowerCase()
                  : "";
                return cleanedTeacherNameJson === cleanedTeacherNameInput;
              });

              if (nameMatches.length === 0) {
                // Không tìm thấy kết quả nào theo tên
                $("#txt-error")
                  .text("Thầy/cô vui lòng kiểm tra lại thông tin.")
                  .show();
                console.log("không có kết quả nào.");
              } else if (nameMatches.length === 1) {
                // Chỉ có 1 kết quả khớp theo tên, không cần kiểm tra ngày sinh
                const foundDataItem = nameMatches[0];
                $("#name").text(foundDataItem["fullname"]);
                $("#sex").text(foundDataItem["chucdanh"]);
                $("#year").text(foundDataItem["nam"]);
                $("#month").text(foundDataItem["thang"]);

                open(); // Chạy hiệu ứng
              } else {
                // Nhiều hơn 1 kết quả khớp theo tên, cần kiểm tra ngày/tháng/năm sinh

                // Kiểm tra từng trường ngày/tháng/năm sinh riêng biệt
                if (!birthDayValue) {
                  //alert("Vui lòng kiểm tra lại ngày sinh.");
                  $("#txt-error").text("Vui lòng nhập Ngày sinh.").show();
                  return;
                }
                if (!birthMonthValue) {
                  //alert("Vui lòng kiểm tra lại tháng sinh.");
                  $("#txt-error").text("Vui lòng nhập Tháng sinh.").show();
                  return;
                }
                if (!birthYearValue) {
                  //alert("Vui lòng kiểm tra lại năm sinh.");
                  $("#txt-error").text("Vui lòng nhập Năm sinh.").show();
                  return;
                }

                // Nếu tất cả các trường đã được nhập, tiến hành parse và so sánh
                const birthDayInput = parseInt(birthDayValue);
                const birthMonthInput = parseInt(birthMonthValue);
                const birthYearInput = parseInt(birthYearValue);

                // Kiểm tra xem các giá trị ngày/tháng/năm sinh có phải là số hợp lệ không
                if (
                  isNaN(birthDayInput) ||
                  isNaN(birthMonthInput) ||
                  isNaN(birthYearInput)
                ) {
                  $("#txt-error")
                    .text(
                      "Ngày, Tháng, Năm sinh không hợp lệ. Vui lòng kiểm tra lại."
                    )
                    .show();
                  return;
                }

                let finalMatches = nameMatches.filter((item) => {
                  const ngaySinhJsonString = item["Ngày sinh"];
                  const birthDateParts = ngaySinhJsonString
                    ? ngaySinhJsonString.split("/")
                    : [];

                  const jsonDay =
                    birthDateParts.length > 0
                      ? parseInt(birthDateParts[0])
                      : NaN;
                  const jsonMonth =
                    birthDateParts.length > 1
                      ? parseInt(birthDateParts[1])
                      : NaN;
                  const jsonYear =
                    birthDateParts.length > 2
                      ? parseInt(birthDateParts[2])
                      : NaN;

                  return (
                    !isNaN(jsonDay) &&
                    jsonDay === birthDayInput &&
                    !isNaN(jsonMonth) &&
                    jsonMonth === birthMonthInput &&
                    !isNaN(jsonYear) &&
                    jsonYear === birthYearInput
                  );
                });

                if (finalMatches.length === 1) {
                  // Tìm thấy 1 kết quả duy nhất sau khi lọc bằng ngày sinh
                  const foundDataItem = finalMatches[0];
                  $("#name").text(foundDataItem["fullname"]);
                  $("#sex").text(foundDataItem["chucdanh"]);
                  $("#year").text(foundDataItem["nam"]);
                  $("#month").text(foundDataItem["thang"]);
                  open(); // Chạy hiệu ứng
                } else {
                  // 0 hoặc nhiều hơn 1 kết quả sau khi lọc bằng ngày sinh
                  $("#txt-error")
                    .text("Thầy/cô vui lòng kiểm tra lại thông tin.")
                    .show();
                  console.log(
                    "0 hoặc nhiều hơn 1 kết quả sau khi lọc bằng ngày sinh"
                  );
                  // alert(
                  //   "Vẫn còn nhiều hơn một kết quả hoặc không tìm thấy sau khi lọc theo ngày sinh. Vui lòng kiểm tra lại thông tin."
                  // );
                }
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.error("Lỗi khi tải dữ liệu:", textStatus, errorThrown);
              $("#txt-error").text("Lỗi khi tải dữ liệu từ server.").show();
            },
          });
        });
      });
      /**
       * Lọc một mảng đối tượng để tìm các đối tượng có giá trị "Họ và tên" trùng lặp.
       *
       * @param {Array<Object>} data Mảng các đối tượng cần lọc.
       * @returns {Array<Object>} Một mảng mới chứa tất cả các đối tượng có giá trị
       * "Họ và tên" xuất hiện nhiều hơn một lần.
       */
      function findDuplicateNames(data) {
        const nameOccurrences = {};

        // Nhóm các đối tượng theo "Họ và tên" và đếm số lần xuất hiện
        data.forEach((item) => {
          const name = item["fullname"];
          if (name) {
            if (!nameOccurrences[name]) {
              nameOccurrences[name] = [];
            }
            nameOccurrences[name].push(item);
          }
        });

        const duplicateNamesData = [];

        // Tìm các tên xuất hiện nhiều hơn một lần và thu thập các đối tượng liên quan
        for (const name in nameOccurrences) {
          if (nameOccurrences.hasOwnProperty(name)) {
            if (nameOccurrences[name].length > 1) {
              duplicateNamesData.push(...nameOccurrences[name]);
            }
          }
        }

        return duplicateNamesData;
      }

      // Đường dẫn đến tệp JSON của bạn
      const jsonFilePath = "asset/js/data.json"; // Đảm bảo đường dẫn này chính xác

      // Sử dụng Fetch API để gửi yêu cầu AJAX
      fetch(jsonFilePath)
        .then((response) => {
          if (!response.ok) {
            // Xử lý lỗi HTTP (ví dụ: 404 Not Found)
            throw new Error(
              `Lỗi HTTP: ${response.status} - ${response.statusText}`
            );
          }
          return response.json(); // Chuyển đổi phản hồi thành đối tượng JSON
        })
        .then((data) => {
          // Dữ liệu đã được tải thành công, tiến hành lọc
          console.log("Dữ liệu gốc từ data.json:", data);

          const duplicateEntries = findDuplicateNames(data);

          if (duplicateEntries.length > 0) {
            console.log("Tìm thấy các đối tượng có 'Họ và tên' trùng lặp:");
            duplicateEntries.forEach((entry) => {
              console.log(JSON.stringify(entry, null, 2));
            });
          } else {
            console.log(
              "Không tìm thấy đối tượng nào có 'Họ và tên' trùng lặp."
            );
          }
        })
        .catch((error) => {
          // Xử lý các lỗi xảy ra trong quá trình fetch hoặc xử lý JSON
          console.error(
            "Đã xảy ra lỗi khi tải hoặc xử lý dữ liệu JSON:",
            error
          );
        });
    </script>
  </body>
</html>
